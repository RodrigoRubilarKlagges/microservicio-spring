#trigger:
#- main

pool:
  vmImage: ubuntu-latest

steps:
  - task: Gradle@3
    displayName: Construir
    inputs:
      gradleWrapperFile: 'gradlew'
      tasks: 'build jacocoTestReport'
      publishJUnitResults: true
      testResultsFiles: '**/TEST-*.xml'
      javaHomeOption: 'JDKVersion'
      sonarQubeRunAnalysis: false
      spotBugsAnalysis: false

  - task: CopyFiles@2
    displayName: Copiar datos
    inputs:
      sourceFolder: '$(Build.SourcesDirectory)'
      contents: |
        **/build/libs/*.jar
        **/build/**/*.xml
      targetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: Publicar
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: appJar
      publishLocation: 'Container'

  - task: DownloadBuildArtifacts@0
    displayName: Descargar
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'appJar'
      downloadPath: '$(Pipeline.Workspace)'


  - task: SonarCloudPrepare@1
    inputs:
      SonarCloud: 'SonarCloud'
      organization: 'rodrigorubilarklagges'
      projectKey: 'RodrigoRubilarKlagges.microservicio-spring'
      projectName: 'microservicio-spring'
      extraProperties: sonar.coverage.jacoco.xmlReportPaths=$(Pipeline.Workspace)/appJar/build/reports/jacoco/test/jacocoTestReport.xml
    displayName: Preparar Sonarqube

  - task: Gradle@3
    displayName: Analizar
    inputs:
      gradleWrapperFile: 'gradlew'
      tasks: 'build jacocoTestReport'
      javaHomeOption: 'JDKVersion'
      sonarQubeRunAnalysis: true
      sqGradlePluginVersionChoice: 'specify'
      sonarQubeGradlePluginVersion: '3.3'


  - task: SonarCloudPublish@1
    displayName: Publicar resultados
    inputs:
      pollingTimeoutSec: '300'

  - task: sonarcloud-buildbreaker@2
    inputs:
      SonarCloud: 'SonarCloud'
      organization: 'rodrigorubilarklagges'

  - script: "mkdir -p build/libs; mv $(Pipeline.Workspace)/appJar/build/libs/ build/; chmod -R 555 build/libs"  
    displayName:  Se mueve JAR a  raiz

  - task: DockerInstaller@0
    inputs:
      dockerVersion: '17.09.0-ce'

  - task: Docker@2
    displayName: iniciar docker
    inputs:
      containerRegistry: 'Docker'
      command: 'login'

  - task: Docker@2
    displayName: construir imagen
    inputs:
      containerRegistry: 'Docker'
      repository: 'rodrigorubilark/microservicio-spring'
      command: 'build'
      Dockerfile: '**/Dockerfile'
      tags: latest

  - task: Docker@2
    inputs:
      containerRegistry: 'Docker'
      repository: 'rodrigorubilark/microservicio-spring'
      command: 'push'
      tags: 'latest'